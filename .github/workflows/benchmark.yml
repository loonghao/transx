name: Run Benchmarks

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  deployments: write
  pull-requests: write

jobs:
  benchmark:
    name: Run pytest-benchmark (Python ${{ matrix.python-version }})
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nox

    - name: Run benchmark
      run: |
        nox -s benchmark

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: TransX Performance Benchmarks (Python ${{ matrix.python-version }})
        tool: 'pytest'
        output-file-path: output.json
        github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        auto-push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        gh-repository: 'github.com/loonghao/transx-benchmarks'
        gh-pages-branch: gh-pages
        benchmark-data-dir-path: data/${{ matrix.python-version }}
        alert-threshold: '200%'
        comment-on-alert: true
        fail-on-alert: true
        alert-comment-cc-users: '@loonghao'
        comment-always: true
        summary-always: true
        max-items-in-chart: 100

  update-index:
    needs: benchmark
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        repository: 'loonghao/transx-benchmarks'
        ref: gh-pages
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    - name: Generate index page
      run: |
        echo "<!DOCTYPE html>" > index.html
        echo "<html><head>" >> index.html
        echo "<title>TransX Performance Benchmarks</title>" >> index.html
        echo "<style>" >> index.html
        echo "body { font-family: Arial, sans-serif; margin: 40px; }" >> index.html
        echo "h1 { color: #333; }" >> index.html
        echo "h2 { color: #666; }" >> index.html
        echo "ul { list-style-type: none; padding: 0; }" >> index.html
        echo "li { margin: 10px 0; }" >> index.html
        echo "a { color: #0366d6; text-decoration: none; }" >> index.html
        echo "a:hover { text-decoration: underline; }" >> index.html
        echo "</style>" >> index.html
        echo "</head><body>" >> index.html
        echo "<h1>TransX Performance Benchmarks</h1>" >> index.html
        echo "<h2>Python Versions</h2>" >> index.html
        echo "<ul>" >> index.html
        for version in 3.7 3.8 3.9 3.10 3.11 3.12; do
          echo "<li><a href='./data/${version}/'>Python ${version} Benchmarks</a></li>" >> index.html
        done
        echo "</ul>" >> index.html
        echo "<p>Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>" >> index.html
        echo "</body></html>" >> index.html

    - name: Commit and push index
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add index.html
        git commit -m "chore: Update benchmark index page" || exit 0
        git push
